# Simple Docker

Введение в докер. Разработка простого докер образа для собственного сервера.

## Part 1. Готовый докер

**== Задание ==**

##### Возмем официальный докер образ с **nginx** и выкачаем его при помощи `docker pull`

![ws1](screen/1.png) <br>*`docker pull nginx`*<br> 

##### Проверим наличие докер образа через `docker images`

![ws1](screen/2.png) <br>*наличие докер образа*<br> 

##### Запустим докер образ через `docker run -d [image_id|repository]` и
##### проверяем, что образ запустился через `docker ps`

![ws1](screen/3.png) <br>*`docker run -d nginx` и `docker ps`*<br> 

##### Посмотряем информацию о контейнере через `docker inspect [container_id|container_name]`

![ws1](screen/4.png) <br>*информация о контейнере*<br> 

##### Определяем размер контейнера, список замапленных портов и ip контейнера

![ws1](screen/5.png) <br>*информация о размере контейнера, списке замапленных портов и об ip контейнера*<br> 

##### Остановим докер образ через `docker stop [container_id|container_name]` и
##### проверим, что образ остановился через `docker ps`

![ws1](screen/6.png) <br>*Остановим докер образ и проверим отсутствие*<br> 

##### Запустим докер с портами 80 и 443 в контейнере, замапленными на такие же порты на локальной машине, через команду *run* и
##### проверим, что в браузере по адресу *localhost:80* доступна стартовая страница **nginx**

![ws1](screen/7.png) <br>*Запустим докер с портами 80 и 443*<br> 

![ws1](screen/8.png) <br>*по адресу localhost:80 доступна стартовая страница*<br> 

##### Перезапустим докер контейнер через `docker restart [container_id|container_name]`
##### и проверим, что контейнер запустился

![ws1](screen/9.png) <br>*перезапуск и проверка докер контейнера*<br> 

## Part 2. Операции с контейнером

**== Задание ==**

##### Прочитаем конфигурационный файл *nginx.conf* внутри докер контейнера через команду *exec*

![ws1](screen/10.png) <br>*конфигурационный файл nginx.conf*<br> 

##### Создаем на локальной машине файл *nginx.conf*
![ws1](screen/11.png) <br>*создаем конфигурационный файл nginx.conf*<br> 

##### Настроим в нем по пути */status* отдачу страницы статуса сервера **nginx**

![ws1](screen/12.png) <br>*настроим пути в файле nginx.conf*<br> 

##### Скопируем созданный файл *nginx.conf* внутрь докер образа через команду `docker cp` и
##### перезапустим **nginx** внутри докер образа через команду *exec*

![ws1](screen/13.png) <br>*скопируем файл nginx.conf и перезапустим nginx*<br> 

##### Проверим, что по адресу *localhost:80/status* отдается страничка со статусом сервера **nginx**

![ws1](screen/14.png) <br>*localhost:80/status*<br> 

##### Экспортируем контейнер в файл *container.tar* через команду *export* и
##### остановим контейнер

![ws1](screen/15.png) <br>*Экспортируем контейнер и после остановим его*<br> 

##### Удалим образ через `docker rmi [image_id|repository]`, не удаляя перед этим контейнеры и
##### удалим остановленный контейнер

![ws1](screen/16.png) <br>*Удалим образ, а затем контейнер*<br> 

##### Импортируем контейнер обратно через команду *import*
##### и запустить импортированный контейнер

![ws1](screen/18.png) <br>*Импортруем и запустим контейнер*<br> 

##### Проверим, что по адресу *localhost:80/status* отдается страничка со статусом сервера **nginx**

![ws1](screen/19.png) <br>*localhost:80/status*<br> 

## Part 3. Мини веб-сервер

**== Задание ==**

##### Напишем мини сервер на **C** и **FastCgi**, который будет возвращать простейшую страничку с надписью `Hello World!`, а также nginx.conf, который будет проксировать все запросы с порта 81 на порт *127.0.0.1:8080*

![ws1](screen/20.png) <br>*создание файлов в папке server*<br> 

![ws1](screen/21.png) <br>*файл server.c*<br> 

![ws1](screen/22.png) <br>*файл nginx.conf*<br> 

##### Запустим написанный мини сервер через *spawn-fcgi* на порту 8080

![ws1](screen/23.png) <br>*Запустим написанный мини сервер*<br> 

![ws1](screen/24.png) <br>*Проверка и получение имени*<br> 

##### Скопируем *nginx.conf* и *server.c* в новый контейнер

![ws1](screen/25.png) <br>*Копирование nginx.conf и server.c в новый контейнер*<br> 

##### Установим требуемые утилиты для запуска мини веб-сервера на FastCGI, в частности `spawn-fcgi` и `libfcgi-dev`

![ws1](screen/26.png) <br>*Установим требуемые утилиты*<br> 

##### Cкомпилируем и запустим мини веб-сервер через команду spawn-fcgi

![ws1](screen/27.png) <br>*Запуск мини веб сервера*<br> 

##### Проверим, что в браузере по *localhost:81* отдается написанная вами страничка

![ws1](screen/28.png) <br>*localhost:81*<br> 

##### Положим файл *nginx.conf* по пути *./nginx/nginx.conf* (это понадобится позже)

![ws1](screen/29.png) <br>*nginx.conf по пути ./nginx/nginx.conf*<br> 

## Part 4. Свой докер

**== Задание ==**

#### Написать свой докер образ, который:
##### 1) собирает исходники мини сервера на FastCgi из [Части 3](#part-3-мини-веб-сервер)
##### 2) запускает его на 8080 порту
##### 3) копирует внутрь образа написанный *./nginx/nginx.conf*
##### 4) запускает **nginx**.

##### Файлы *nginx.conf* и *server.c* остаются с 3 части.
##### Создадим файл *run.sh* и *Dockerfile*

![ws1](screen/30.png) <br>*файл run.sh*<br> 

![ws1](screen/31.png) <br>*файл Dockerfile*<br> 

##### Собрем написанный докер образ через `docker build` при этом указав имя и тег

![ws1](screen/32.png) <br>*Сборка написанного докер образа*<br> 

##### Проверим через `docker images`, что все собралось корректно

![ws1](screen/33.png) <br>*Проверка*<br> 

##### Запустим собранный докер образ с маппингом 81 порта на 80 на локальной машине и маппингом папки *./nginx* внутрь контейнера по адресу, где лежат конфигурационные файлы **nginx**'а (см. [Часть 2](#part-2-операции-с-контейнером))

![ws1](screen/34.png) <br>*Запуск собранного докер образа*<br> 

##### Проверим, что по localhost:80 доступна страничка написанного мини сервера

![ws1](screen/35.0.png) <br>*Проверка в терминале*<br> 

![ws1](screen/35.1.png) <br>*localhost:80*<br> 

##### Допишем в *nginx.conf* проксирование странички */status*, по которой надо отдавать статус сервера **nginx**

![ws1](screen/36.png) <br>*nginx.conf проксирование странички /status*<br> 

##### Перезапустим докер образ
 
![ws1](screen/37.png) <br>*Перезапуск*<br> 

##### Проверим, что теперь по *localhost:80/status* отдается страничка со статусом **nginx**

![ws1](screen/38.png) <br>*localhost:80/status*<br> 

## Part 5. **Dockle**

После написания образа никогда не будет лишним проверить его на безопасность.

**== Задание ==**

##### Просканируем образ из предыдущего задания через `dockle [image_id|repository]`

![ws1](screen/39.png) <br>*Просканируем образ `dockle`*<br> 

##### Исправим образ так, чтобы при проверке через **dockle** не было ошибок и предупреждений

Исправим Dockerfile

![ws1](screen/40.png) <br>*Исправим Dockerfile*<br>

##### Переапустим образ и
##### снова просканируем образ из предыдущего задания через `dockle`

![ws1](screen/41.png) <br>*Перезапустим*<br>

![ws1](screen/42.png) <br>*Просканируем образ `dockle`*<br> 

## Part 6. Базовый **Docker Compose**

**== Задание ==**

##### Напишем файл *docker-compose.yml*, с помощью которого надо:
##### 1) Поднять докер контейнер из [Части 5](#part-5-инструмент-dockle) _(он должен работать в локальной сети, т.е. не нужно использовать инструкцию **EXPOSE** и мапить порты на локальную машину)_
##### 2) Поднять докер контейнер с **nginx**, который будет проксировать все запросы с 8080 порта на 81 порт первого контейнера

##### Для начала остановм все запущенные контенеры

![ws1](screen/43.png) <br>*остановм все запущенные контенеры*<br> 

##### Напишем файл *docker-compose.yml*

![ws1](screen/44.png) <br>*docker-compose.yml*<br> 

Чтобы не изменять конфигурационные файлы, будем собирать из папки compose, запуск будет происходить из этой папки.

![ws1](screen/47.png) <br>*Dockerfile*<br> 

##### Замапим 8080 порт второго контейнера на 80 порт локальной машины

![ws1](screen/48.png) <br>*nginx.conf*<br> 

![ws1](screen/49.png) <br>*run.sh*<br> 

##### Собрем и запустим проект с помощью команд `docker-compose build` и `docker-compose up`

![ws1](screen/50.png) <br>*Сборка проекта*<br> 

![ws1](screen/51.png) <br>*Запуск проекта*<br> 

##### Проверим, что в браузере по *localhost:80* отдается написанная вами страничка

![ws1](screen/52.png) <br>*localhost:80*<br> 

![ws1](screen/53.png) <br>*Проверка через терминал*<br> 